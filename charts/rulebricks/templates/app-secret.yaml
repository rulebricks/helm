{{/*
Rulebricks Application Secret
Contains all sensitive configuration values for the Rulebricks application.
This secret is only created if global.secrets.secretRef is NOT set.
Enterprise users can provide their own pre-existing secret via global.secrets.secretRef.
*/}}
{{- $secretRef := "" }}
{{- if and .Values.global .Values.global.secrets .Values.global.secrets.secretRef }}
  {{- $secretRef = .Values.global.secrets.secretRef }}
{{- end }}
{{- if not $secretRef }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "rulebricks-chart.app.secret" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rulebricks-chart.labels" . | nindent 4 }}
type: Opaque
stringData:
  # License and contact
  LICENSE_KEY: {{ .Values.global.licenseKey | default .Values.app.licenseKey | default "" | quote }}
  EMAIL: {{ .Values.global.email | default .Values.app.email | default "" | quote }}
  # SMTP credentials
  {{- $smtpUser := "" }}
  {{- $smtpPass := "" }}
  {{- if and .Values.global .Values.global.smtp }}
    {{- $smtpUser = .Values.global.smtp.user | default "" }}
    {{- $smtpPass = .Values.global.smtp.pass | default "" }}
  {{- else if .Values.app.smtp }}
    {{- $smtpUser = .Values.app.smtp.user | default "" }}
    {{- $smtpPass = .Values.app.smtp.pass | default "" }}
  {{- end }}
  SMTP_USER: {{ $smtpUser | quote }}
  SMTP_PASS: {{ $smtpPass | quote }}
  # Supabase keys
  {{- $supabaseAnonKey := "" }}
  {{- $supabaseServiceKey := "" }}
  {{- $supabaseAccessToken := "" }}
  {{- if and .Values.global .Values.global.supabase }}
    {{- $supabaseAnonKey = .Values.global.supabase.anonKey | default "" }}
    {{- $supabaseServiceKey = .Values.global.supabase.serviceKey | default "" }}
    {{- $supabaseAccessToken = .Values.global.supabase.accessToken | default "" }}
  {{- end }}
  SUPABASE_ANON_KEY: {{ $supabaseAnonKey | quote }}
  SUPABASE_SERVICE_KEY: {{ $supabaseServiceKey | quote }}
  SUPABASE_SECRET_KEY: {{ $supabaseServiceKey | quote }}
  SUPABASE_ACCESS_TOKEN: {{ $supabaseAccessToken | quote }}
  # AI features
  {{- $openaiApiKey := "" }}
  {{- if and .Values.global .Values.global.ai .Values.global.ai.openaiApiKey }}
    {{- $openaiApiKey = .Values.global.ai.openaiApiKey }}
  {{- else if and .Values.app.ai .Values.app.ai.openaiApiKey }}
    {{- $openaiApiKey = .Values.app.ai.openaiApiKey }}
  {{- end }}
  OPENAI_API_KEY: {{ $openaiApiKey | quote }}
{{- end }}
