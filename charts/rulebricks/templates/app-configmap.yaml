{{- $domain := .Values.global.domain | default "localhost" -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "rulebricks-chart.app.configmap" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rulebricks-chart.labels" . | nindent 4 }}
data:
  {{- /* App always expects HTTPS - no dependency on global.tlsEnabled */ -}}
  {{- $protocol := "https" }}
  {{- $tlsEnabled := eq (include "rulebricks-chart.tlsEnabled" .) "true" }}
  {{- $routerEntrypoint := ternary "websecure" "web" $tlsEnabled }}
  PROTOCOL: "https"
  DOMAIN_NAME: {{ $domain | quote }}
  ROUTER_ENTRYPOINT: {{ $routerEntrypoint | quote }}
  # Supabase configuration (non-sensitive)
  # - Self-hosted (supabase.enabled: true): URL derived from global.domain
  # - External (supabase.enabled: false): URL from global.supabase.url
  # Note: Sensitive keys (anonKey, serviceKey) are stored in the app secret
  {{- $supabaseAnonKey := "" }}
  {{- $supabaseUrl := "" }}
  {{- if and .Values.global .Values.global.supabase }}
    {{- $supabaseAnonKey = .Values.global.supabase.anonKey | default "" }}
    {{- /* Check if external Supabase URL is explicitly provided */ -}}
    {{- if .Values.global.supabase.url }}
      {{- $supabaseUrl = .Values.global.supabase.url }}
    {{- end }}
  {{- end }}
  {{- /* If no explicit URL, derive public URL from global.domain (self-hosted) */ -}}
  {{- if not $supabaseUrl }}
    {{- $supabaseUrl = printf "%s://supabase.%s" $protocol $domain }}
  {{- end }}
  # Public key is safe for ConfigMap (embedded in client bundle for Next.js)
  SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_EMAIL: {{ .Values.global.email | default .Values.app.email | default "" | quote }}
  NEXT_PUBLIC_PROTOCOL: "https"
  NEXT_PUBLIC_DOMAIN_NAME: {{ $domain | quote }}
  NEXT_PUBLIC_SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SELF_HOSTED: "1"
  NEXT_PUBLIC_SELF_HOSTED: "1"
  NEXT_PUBLIC_SANITY_PROJECT_ID: "0tthc473"
  SANITY_PROJECT_ID: "0tthc473"
  SANITY_API_DATASET: "production"
  # Redis HTTP service - using templated service name
  KV_REST_API_URL: {{ printf "http://%s.%s.svc.cluster.local" (include "rulebricks-chart.serverless-redis-http.fullname" .) .Release.Namespace | quote }}
  KV_REST_API_TOKEN: "local_redis"
  # Raw redis URL for direct solutions
  REDIS_URL: {{ printf "redis://%s.%s.svc.cluster.local:6379" (include "rulebricks-chart.redis.fullname" .) .Release.Namespace | quote }}
  NODE_ENV: "production"
  ENVIRONMENT: "production"
  NODE_OPTIONS: "--dns-result-order=ipv4first"
  # SMTP configuration (non-sensitive only - credentials are in the app secret)
  {{- if .Values.global.smtp }}
  SMTP_HOST: {{ .Values.global.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.global.smtp.port | default "" | quote }}
  SMTP_FROM: {{ .Values.global.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.global.smtp.fromName | default "" | quote }}
  {{- else if .Values.app.smtp }}
  SMTP_HOST: {{ .Values.app.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.app.smtp.port | default "" | quote }}
  SMTP_FROM: {{ .Values.app.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.app.smtp.fromName | default "" | quote }}
  {{- end }}
  # AI Features - only the enabled flag (API key is in the app secret)
  {{- $aiEnabled := false }}
  {{- if and .Values.global .Values.global.ai .Values.global.ai.enabled }}
    {{- $aiEnabled = true }}
  {{- else if and .Values.app.ai .Values.app.ai.enabled }}
    {{- $aiEnabled = true }}
  {{- end }}
  {{- if $aiEnabled }}
  NEXT_PUBLIC_AI_ENABLED: "1"
  {{- end }}
  # Kafka/Logging configuration
  {{- if .Values.app.logging }}
  {{- if .Values.app.logging.enabled }}
  KAFKA_ENABLED: "1"
  # Kafka brokers - use templated URL if not explicitly set
  {{- $kafkaBrokers := .Values.app.logging.kafkaBrokers | default (include "rulebricks-chart.kafka.bootstrapServers" .) }}
  KAFKA_BROKERS: {{ $kafkaBrokers | quote }}
  KAFKA_TOPIC: {{ .Values.app.logging.kafkaTopic | default "logs" | quote }}
  NEXT_PUBLIC_LOGGING_DESTINATION: {{ .Values.app.logging.loggingDestination | default "" | quote }}
  {{- end }}
  {{- end }}
  # Enterprise SSO Configuration
  # Tells the frontend which provider is configured and enables SSO login flow
  {{- if and .Values.global .Values.global.sso .Values.global.sso.enabled .Values.global.sso.provider }}
  NEXT_PUBLIC_SSO_ENABLED: "1"
  {{- /* Map provider to Supabase provider name */ -}}
  {{- $provider := .Values.global.sso.provider }}
  {{- $nativeProviders := list "azure" "google" "okta" "keycloak" }}
  {{- $isNative := has $provider $nativeProviders }}
  {{- /* Okta uses WorkOS, custom providers use Keycloak as OIDC handler */ -}}
  {{- $ssoProvider := $provider }}
  {{- if eq $provider "okta" }}
    {{- $ssoProvider = "workos" }}
  {{- else if not $isNative }}
    {{- $ssoProvider = "keycloak" }}
  {{- end }}
  NEXT_PUBLIC_SSO_PROVIDER: {{ $ssoProvider | quote }}
  # Raw provider name for app proxy logic (ory, azure, etc.)
  SSO_PROVIDER: {{ $provider | quote }}
  {{- if .Values.global.sso.url }}
  # IdP URL for app's built-in OIDC proxy (used for custom providers)
  SSO_PROVIDER_URL: {{ .Values.global.sso.url | quote }}
  {{- end }}
  {{- end }}