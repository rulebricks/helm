{{- $host0 := index .Values.ingress.hosts 0 -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "rulebricks-chart.app.configmap" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rulebricks-chart.labels" . | nindent 4 }}
data:
  {{- $tlsEnabled := eq (include "rulebricks-chart.tlsEnabled" .) "true" }}
  {{- $protocol := ternary "https" "http" $tlsEnabled }}
  {{- $routerEntrypoint := ternary "websecure" "web" $tlsEnabled }}
  PROTOCOL: {{ $protocol | quote }}
  DOMAIN_NAME: {{ $host0.host | quote }}
  ROUTER_ENTRYPOINT: {{ $routerEntrypoint | quote }}
  # Supabase configuration - prefer global.supabase.*, fallback to app.* for backward compatibility
  {{- $supabaseUrl := "" }}
  {{- $supabaseAnonKey := "" }}
  {{- $supabaseServiceKey := "" }}
  {{- if and .Values.global .Values.global.supabase }}
    {{- $supabaseUrl = .Values.global.supabase.url | default "" }}
    {{- $supabaseAnonKey = .Values.global.supabase.anonKey | default "" }}
    {{- $supabaseServiceKey = .Values.global.supabase.serviceKey | default "" }}
  {{- end }}
  {{- if not $supabaseUrl }}
    {{- $supabaseUrl = .Values.app.supabaseUrl | default (include "rulebricks-chart.supabase.kongUrl" .) }}
  {{- end }}
  {{- if not $supabaseAnonKey }}
    {{- $supabaseAnonKey = .Values.app.supabaseAnonKey | default "" }}
  {{- end }}
  {{- if not $supabaseServiceKey }}
    {{- $supabaseServiceKey = .Values.app.supabaseServiceKey | default "" }}
  {{- end }}
  SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SUPABASE_SECRET_KEY: {{ $supabaseServiceKey | quote }}
  SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_EMAIL: {{ .Values.global.email | default .Values.app.email | default "" | quote }}
  NEXT_PUBLIC_PROTOCOL: {{ $protocol | quote }}
  NEXT_PUBLIC_DOMAIN_NAME: {{ $host0.host | quote }}
  NEXT_PUBLIC_SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SELF_HOSTED: "1"
  NEXT_PUBLIC_SELF_HOSTED: "1"
  NEXT_PUBLIC_SANITY_PROJECT_ID: "0tthc473"
  SANITY_PROJECT_ID: "0tthc473"
  SANITY_API_DATASET: "production"
  # Redis HTTP service - using templated service name
  KV_REST_API_URL: {{ printf "http://%s.%s.svc.cluster.local" (include "rulebricks-chart.serverless-redis-http.fullname" .) .Release.Namespace | quote }}
  KV_REST_API_TOKEN: "local_redis"
  NODE_ENV: "production"
  ENVIRONMENT: "production"
  NODE_OPTIONS: "--dns-result-order=ipv4first"
  {{- if .Values.global.smtp }}
  SMTP_HOST: {{ .Values.global.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.global.smtp.port | default "" | quote }}
  SMTP_USER: {{ .Values.global.smtp.user | default "" | quote }}
  SMTP_PASS: {{ .Values.global.smtp.pass | default "" | quote }}
  SMTP_FROM: {{ .Values.global.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.global.smtp.fromName | default "" | quote }}
  {{- else if .Values.app.smtp }}
  SMTP_HOST: {{ .Values.app.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.app.smtp.port | default "" | quote }}
  SMTP_USER: {{ .Values.app.smtp.user | default "" | quote }}
  SMTP_PASS: {{ .Values.app.smtp.pass | default "" | quote }}
  SMTP_FROM: {{ .Values.app.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.app.smtp.fromName | default "" | quote }}
  {{- end }}
  {{- if .Values.app.ai }}
  {{- if .Values.app.ai.enabled }}
  NEXT_PUBLIC_AI_ENABLED: "1"
  OPENAI_API_KEY: {{ .Values.app.ai.openaiApiKey | default "" | quote }}
  {{- end }}
  {{- end }}
  {{- if .Values.app.logging }}
  {{- if .Values.app.logging.enabled }}
  KAFKA_ENABLED: "1"
  # Kafka brokers - use templated URL if not explicitly set
  {{- $kafkaBrokers := .Values.app.logging.kafkaBrokers | default (include "rulebricks-chart.kafka.bootstrapServers" .) }}
  KAFKA_BROKERS: {{ $kafkaBrokers | quote }}
  KAFKA_TOPIC: {{ .Values.app.logging.kafkaTopic | default "logs" | quote }}
  NEXT_PUBLIC_LOGGING_DESTINATION: {{ .Values.app.logging.loggingDestination | default "" | quote }}
  {{- end }}
  {{- end }}
