{{- $domain := .Values.global.domain | default "localhost" -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "rulebricks-chart.app.configmap" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rulebricks-chart.labels" . | nindent 4 }}
data:
  {{- $tlsEnabled := eq (include "rulebricks-chart.tlsEnabled" .) "true" }}
  {{- $protocol := ternary "https" "http" $tlsEnabled }}
  {{- $routerEntrypoint := ternary "websecure" "web" $tlsEnabled }}
  PROTOCOL: {{ $protocol | quote }}
  DOMAIN_NAME: {{ $domain | quote }}
  ROUTER_ENTRYPOINT: {{ $routerEntrypoint | quote }}
  # Supabase configuration
  # - Self-hosted (supabase.enabled: true): URL derived from global.domain
  # - External (supabase.enabled: false): URL from global.supabase.url
  {{- $supabaseAnonKey := "" }}
  {{- $supabaseServiceKey := "" }}
  {{- $supabaseUrl := "" }}
  {{- if and .Values.global .Values.global.supabase }}
    {{- $supabaseAnonKey = .Values.global.supabase.anonKey | default "" }}
    {{- $supabaseServiceKey = .Values.global.supabase.serviceKey | default "" }}
    {{- /* Check if external Supabase URL is explicitly provided */ -}}
    {{- if .Values.global.supabase.url }}
      {{- $supabaseUrl = .Values.global.supabase.url }}
    {{- end }}
  {{- end }}
  {{- /* If no explicit URL, derive public URL from global.domain (self-hosted) */ -}}
  {{- if not $supabaseUrl }}
    {{- $supabaseUrl = printf "%s://supabase.%s" $protocol $domain }}
  {{- end }}
  SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SUPABASE_SECRET_KEY: {{ $supabaseServiceKey | quote }}
  SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_EMAIL: {{ .Values.global.email | default .Values.app.email | default "" | quote }}
  NEXT_PUBLIC_PROTOCOL: {{ $protocol | quote }}
  NEXT_PUBLIC_DOMAIN_NAME: {{ $domain | quote }}
  NEXT_PUBLIC_SUPABASE_URL: {{ $supabaseUrl | quote }}
  NEXT_PUBLIC_SUPABASE_PUBLIC_KEY: {{ $supabaseAnonKey | quote }}
  SELF_HOSTED: "1"
  NEXT_PUBLIC_SELF_HOSTED: "1"
  NEXT_PUBLIC_SANITY_PROJECT_ID: "0tthc473"
  SANITY_PROJECT_ID: "0tthc473"
  SANITY_API_DATASET: "production"
  # Redis HTTP service - using templated service name
  KV_REST_API_URL: {{ printf "http://%s.%s.svc.cluster.local" (include "rulebricks-chart.serverless-redis-http.fullname" .) .Release.Namespace | quote }}
  KV_REST_API_TOKEN: "local_redis"
  NODE_ENV: "production"
  ENVIRONMENT: "production"
  NODE_OPTIONS: "--dns-result-order=ipv4first"
  {{- if .Values.global.smtp }}
  SMTP_HOST: {{ .Values.global.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.global.smtp.port | default "" | quote }}
  SMTP_USER: {{ .Values.global.smtp.user | default "" | quote }}
  SMTP_PASS: {{ .Values.global.smtp.pass | default "" | quote }}
  SMTP_FROM: {{ .Values.global.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.global.smtp.fromName | default "" | quote }}
  {{- else if .Values.app.smtp }}
  SMTP_HOST: {{ .Values.app.smtp.host | default "" | quote }}
  SMTP_PORT: {{ .Values.app.smtp.port | default "" | quote }}
  SMTP_USER: {{ .Values.app.smtp.user | default "" | quote }}
  SMTP_PASS: {{ .Values.app.smtp.pass | default "" | quote }}
  SMTP_FROM: {{ .Values.app.smtp.from | default "" | quote }}
  SMTP_FROM_NAME: {{ .Values.app.smtp.fromName | default "" | quote }}
  {{- end }}
  # AI Features - prefer global.ai, fallback to app.ai
  {{- $aiEnabled := false }}
  {{- $openaiApiKey := "" }}
  {{- if and .Values.global .Values.global.ai .Values.global.ai.enabled }}
    {{- $aiEnabled = true }}
    {{- $openaiApiKey = .Values.global.ai.openaiApiKey | default "" }}
  {{- else if and .Values.app.ai .Values.app.ai.enabled }}
    {{- $aiEnabled = true }}
    {{- $openaiApiKey = .Values.app.ai.openaiApiKey | default "" }}
  {{- end }}
  {{- if $aiEnabled }}
  NEXT_PUBLIC_AI_ENABLED: "1"
  OPENAI_API_KEY: {{ $openaiApiKey | quote }}
  {{- end }}
  {{- if .Values.app.logging }}
  {{- if .Values.app.logging.enabled }}
  KAFKA_ENABLED: "1"
  # Kafka brokers - use templated URL if not explicitly set
  {{- $kafkaBrokers := .Values.app.logging.kafkaBrokers | default (include "rulebricks-chart.kafka.bootstrapServers" .) }}
  KAFKA_BROKERS: {{ $kafkaBrokers | quote }}
  KAFKA_TOPIC: {{ .Values.app.logging.kafkaTopic | default "logs" | quote }}
  NEXT_PUBLIC_LOGGING_DESTINATION: {{ .Values.app.logging.loggingDestination | default "" | quote }}
  {{- end }}
  {{- end }}
