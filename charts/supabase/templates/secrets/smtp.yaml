{{- if or .Values.secret.smtp .Values.global.smtp }}
{{- if not (and .Values.secret.smtp .Values.secret.smtp.secretRef) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "supabase.secret.smtp" . }}
  labels:
    {{- include "supabase.labels" . | nindent 4 }}
type: Opaque
data:
  {{- /* Prefer global.smtp credentials if defined, fallback to secret.smtp */ -}}
  {{- $username := "" }}
  {{- $password := "" }}
  {{- if and .Values.global .Values.global.smtp }}
    {{- $username = .Values.global.smtp.user | default "" }}
    {{- $password = .Values.global.smtp.pass | default "" }}
  {{- end }}
  {{- if and (not $username) .Values.secret.smtp }}
    {{- $username = .Values.secret.smtp.username | default "" }}
  {{- end }}
  {{- if and (not $password) .Values.secret.smtp }}
    {{- $password = .Values.secret.smtp.password | default "" }}
  {{- end }}
  {{- if $username }}
  username: {{ $username | b64enc }}
  {{- end }}
  {{- if $password }}
  password: {{ $password | b64enc }}
  {{- end }}
{{- end }}
{{- end }}
