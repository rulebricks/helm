{{- if or .Values.secret.jwt .Values.global.supabase }}
{{- if not (and .Values.secret.jwt .Values.secret.jwt.secretRef) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "supabase.secret.jwt" . }}
  labels:
    {{- include "supabase.labels" . | nindent 4 }}
type: Opaque
data:
  {{- /* Prefer global.supabase.* values, fallback to secret.jwt.* */ -}}
  {{- $anonKey := "" }}
  {{- $serviceKey := "" }}
  {{- $secret := "" }}
  {{- if and .Values.global .Values.global.supabase }}
    {{- $anonKey = .Values.global.supabase.anonKey | default "" }}
    {{- $serviceKey = .Values.global.supabase.serviceKey | default "" }}
    {{- $secret = .Values.global.supabase.jwtSecret | default "" }}
  {{- end }}
  {{- if and (not $anonKey) .Values.secret.jwt }}
    {{- $anonKey = .Values.secret.jwt.anonKey | default "" }}
  {{- end }}
  {{- if and (not $serviceKey) .Values.secret.jwt }}
    {{- $serviceKey = .Values.secret.jwt.serviceKey | default "" }}
  {{- end }}
  {{- if and (not $secret) .Values.secret.jwt }}
    {{- $secret = .Values.secret.jwt.secret | default "" }}
  {{- end }}
  {{- if $anonKey }}
  anonKey: {{ $anonKey | b64enc }}
  {{- end }}
  {{- if $serviceKey }}
  serviceKey: {{ $serviceKey | b64enc }}
  {{- end }}
  {{- if $secret }}
  secret: {{ $secret | b64enc }}
  {{- end }}
{{- end }}
{{- end }}
