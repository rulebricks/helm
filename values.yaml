# =============================================================================
# GLOBAL SETTINGS
# These values are used across multiple components and should be set here
# =============================================================================
global:
  # Domain for ingress and TLS certificate generation
  domain: "rulebricks.local"
  # Email for TLS certificate registration (required for cert-manager)
  email: "admin@rulebricks.com"

# =============================================================================
# RULEBRICKS APPLICATION
# =============================================================================
rulebricks:
  imageCredentials:
    registry: index.docker.io
    username: rulebricks
    password: "dckr_pat_<license-key>"

  app:
    image:
      repository: index.docker.io/rulebricks/app
      pullPolicy: IfNotPresent
      tag: "latest"

    # License and contact
    licenseKey: "<license-key>"
    email: "support@rulebricks.com"

    # TLS Configuration - when enabled, cert-manager will provision certificates
    tlsEnabled: true

    # Supabase Connection
    # Leave empty to auto-discover from the supabase subchart (recommended)
    # Only set explicitly if using an external Supabase instance
    supabaseUrl: ""

    # JWTs must be valid HS256 tokens signed with the JWT secret below.
    # These are demo tokens signed with "super-secret-jwt-token-change-me".
    # REPLACE THESE for production!
    supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE"
    supabaseServiceKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q"

    replicas: 2
    resources:
      requests:
        cpu: "512m"
        memory: "512Mi"
      limits:
        cpu: "1150m"
        memory: "1Gi"

    # Autoscaling configuration
    autoscaling:
      enabled: true
      minReplicas: 1
      maxReplicas: 6
      targetCPUUtilizationPercentage: 50
      targetMemoryUtilizationPercentage: 80

    smtp:
      host: "smtp.mailtrap.io"
      port: 2525
      user: "demo-user"
      pass: "demo-password"
      from: "no-reply@rulebricks.com"
      fromName: "Rulebricks"

    logging:
      enabled: true
      # Leave empty to auto-discover Kafka from the kafka subchart (recommended)
      # Only set explicitly if using an external Kafka cluster
      kafkaBrokers: ""
      kafkaTopic: "logs"
      loggingDestination: "Console (stdout)"

  ingress:
    enabled: true
    className: traefik
    hosts:
      - host: "rulebricks.local"
        paths:
          - path: /
            pathType: Prefix
  redis:
    persistence:
      storageClass: gp2

  hps:
    enabled: true
    replicas: 1
    workers:
      enabled: true
      replicas: 3
      keda:
        enabled: true
        minReplicaCount: 3
        maxReplicaCount: 50
        pollingInterval: 15
        cooldownPeriod: 300
        lagThreshold: 100
        cpuThreshold: 25

# Database (Supabase)
supabase:
  enabled: true
  secret:
    jwt:
      # This secret MUST match the signature of the tokens above.
      # Generate new tokens if you change this!
      secret: "your-super-secret-jwt-token-with-at-least-32-characters-long"
      anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE"
      serviceKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q"
    db:
      username: "postgres"
      password: "postgres-password-change-me"
      database: "postgres"
    dashboard:
      username: "supabase"
      password: "dashboard-password-change-me"
    smtp:
      username: "demo-user"
      password: "demo-password"
    analytics:
      apiKey: "example-analytics-key"
  db:
    enabled: true
    image:
      repository: supabase/postgres
      tag: "15.1.0.147"
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
    persistence:
      enabled: true
      size: 10Gi
      storageClassName: gp2
  studio:
    enabled: true
    image:
      repository: supabase/studio
      tag: "20231123-64a766a"
  auth:
    enabled: true
    image:
      repository: supabase/gotrue
      tag: "v2.132.3"
    environment:
      GOTRUE_SMTP_HOST: "smtp.mailtrap.io"
      GOTRUE_SMTP_PORT: "2525"
      GOTRUE_SMTP_ADMIN_EMAIL: "admin@rulebricks.com"
      GOTRUE_SMTP_SENDER_NAME: "Rulebricks"
  rest:
    enabled: true
    image:
      repository: postgrest/postgrest
      tag: "v12.0.1"
  realtime:
    enabled: true
    image:
      repository: supabase/realtime
      tag: "v2.25.50"
  functions:
    enabled: false
    image:
      repository: supabase/edge-runtime
      tag: "v1.29.1"
  storage:
    enabled: false
    image:
      repository: supabase/storage-api
      tag: "v0.46.4"
  meta:
    enabled: true
    image:
      repository: supabase/postgres-meta
      tag: "v0.75.0"
  kong:
    enabled: true
    image:
      repository: kong
      tag: "2.8.1"
  imgproxy:
    enabled: false
    image:
      repository: darthsim/imgproxy
      tag: "v3.8.0"
  analytics:
    enabled: false
    image:
      repository: supabase/logflare
      tag: "1.4.0"
  vector:
    enabled: false
    image:
      repository: timberio/vector
      tag: "0.28.1-alpine"

# Message Queue (Kafka)
kafka:
  enabled: true
  controller:
    replicaCount: 1
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
    persistence:
      enabled: true
      size: 10Gi
      storageClass: gp2
  listeners:
    client:
      protocol: PLAINTEXT

# Ingress Controller (Traefik)
traefik:
  enabled: true
  ports:
    web:
      port: 8000
      exposedPort: 80
    websecure:
      port: 8443
      exposedPort: 443
  persistence:
    enabled: false

# Autoscaling (KEDA)
keda:
  enabled: true
  crds:
    install: false # CRDs are managed in parent chart crds/ directory

# Certificate Management (cert-manager)
cert-manager:
  enabled: true
  installCRDs: false # CRDs are managed in parent chart crds/ directory

# =============================================================================
# LOGGING (Vector)
# Note: The bootstrap_servers will need to match your release name.
# If your release is named "rulebricks", use "rulebricks-kafka:9092"
# If using a different release name, update accordingly.
# =============================================================================
vector:
  enabled: true
  role: "Stateless-Aggregator"
  replicas: 1
  service:
    enabled: true
    ports:
      - name: api
        port: 8686
        protocol: TCP
        targetPort: 8686
  # IMPORTANT: Update bootstrap_servers to match your helm release name
  # Format: <release-name>-kafka.<namespace>.svc.cluster.local:9092
  # For local cluster DNS, short name also works: <release-name>-kafka:9092
  customConfig:
    sources:
      kafka:
        type: kafka
        # This will be <release-name>-kafka:9092 - adjust if using different release name
        bootstrap_servers: "${KAFKA_BOOTSTRAP_SERVERS:-rulebricks-standalone-kafka:9092}"
        topics:
          - logs
        group_id: vector-consumers
        auto_offset_reset: latest
    sinks:
      console:
        type: console
        inputs:
          - kafka
        encoding:
          codec: json

# Monitoring (Prometheus only)
monitoring:
  enabled: true

kube-prometheus-stack:
  alertmanager:
    enabled: false
  grafana:
    enabled: false
  prometheus:
    prometheusSpec:
      retention: 7d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: gp2
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
      remoteWrite: []

# Automated Migrations
migrations:
  enabled: true
  image:
    repository: index.docker.io/rulebricks/app
    tag: "latest"
